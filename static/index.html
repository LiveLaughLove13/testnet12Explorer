<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa Testnet 12 Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-blue-400">Kaspa Testnet 12 Explorer</h1>
                <div id="network-status" class="flex items-center space-x-2">
                    <div class="loader" id="status-loader"></div>
                    <span id="status-text">Connecting...</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Network Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-2 text-blue-400">Network</h3>
                <p class="text-2xl font-bold" id="network-name">-</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-2 text-green-400">Server</h3>
                <p class="text-sm font-mono" id="server-url">-</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-2 text-yellow-400">Status</h3>
                <p class="text-2xl font-bold" id="connection-status">-</p>
            </div>
        </div>

        <!-- Address Search -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 text-purple-400">Address Balance Lookup</h3>
            <div class="flex space-x-4">
                <input 
                    type="text" 
                    id="address-input" 
                    placeholder="Enter Kaspa address (e.g., kaspatest:qpeyn23ju80dkgx3puldxuhmesey208lzh36kej8efk7lla6gufeqe8gt9vhg)"
                    class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-blue-500"
                />
                <button 
                    onclick="searchAddress()" 
                    class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg text-sm font-medium"
                >
                    Search Address
                </button>
            </div>
            <div id="address-result" class="mt-4 hidden">
                <!-- Address balance results will be displayed here -->
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-gray-700 mb-6">
            <nav class="-mb-px flex space-x-8">
                <button onclick="showTab('blocks')" class="tab-button text-blue-400 border-b-2 border-blue-400 py-2 px-1 text-sm font-medium" data-tab="blocks">
                    Latest Blocks
                </button>
                <button onclick="showTab('mempool')" class="tab-button text-gray-400 hover:text-gray-200 py-2 px-1 text-sm font-medium" data-tab="mempool">
                    Mempool
                </button>
            </nav>
        </div>

        <!-- Blocks Tab -->
        <div id="blocks-tab" class="tab-content">
            <div class="mb-4">
                <button onclick="refreshBlocks()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium">
                    Refresh Blocks
                </button>
            </div>
            <div id="blocks-container" class="space-y-4">
                <div class="text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p>Loading blocks...</p>
                </div>
            </div>
        </div>

        <!-- Mempool Tab -->
        <div id="mempool-tab" class="tab-content hidden">
            <div class="mb-4">
                <button onclick="refreshMempool()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium">
                    Refresh Mempool
                </button>
            </div>
            <div id="mempool-container" class="space-y-4">
                <div class="text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p>Loading mempool...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentTab = 'blocks';

        async function fetchNetworkInfo() {
            try {
                const response = await axios.get(`${API_BASE}/info`);
                const info = response.data;
                
                document.getElementById('network-name').textContent = info.network;
                document.getElementById('server-url').textContent = info.server_url;
                document.getElementById('connection-status').textContent = info.is_connected ? 'Connected' : 'Disconnected';
                
                const statusLoader = document.getElementById('status-loader');
                const statusText = document.getElementById('status-text');
                
                if (info.is_connected) {
                    statusLoader.style.display = 'none';
                    statusText.textContent = 'Connected';
                    statusText.className = 'text-green-400';
                } else {
                    statusLoader.style.display = 'block';
                    statusText.textContent = 'Disconnected';
                    statusText.className = 'text-red-400';
                }
                
                return info.is_connected;
            } catch (error) {
                console.error('Failed to fetch network info:', error);
                document.getElementById('status-loader').style.display = 'none';
                document.getElementById('status-text').textContent = 'Error';
                document.getElementById('status-text').className = 'text-red-400';
                return false;
            }
        }

        async function fetchBlocks() {
            try {
                const response = await axios.get(`${API_BASE}/blocks`);
                const blocks = response.data;
                displayBlocks(blocks);
            } catch (error) {
                console.error('Failed to fetch blocks:', error);
                document.getElementById('blocks-container').innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <p>Failed to load blocks: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayBlocks(blocks) {
            const container = document.getElementById('blocks-container');
            
            if (blocks.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No blocks found</div>';
                return;
            }

            container.innerHTML = blocks.map(block => `
                <div class="bg-gray-800 rounded-lg p-6 hover:bg-gray-750 transition-colors">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <span class="text-blue-400 font-mono text-sm">#${block.level}</span>
                            <h3 class="font-mono text-sm break-all">${block.hash}</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-400">${new Date(block.timestamp * 1000).toLocaleString()}</p>
                            <p class="text-xs text-gray-500">Difficulty: ${block.difficulty.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-400">Parents:</span>
                            <p class="font-mono text-xs break-all">${block.parents || 'None'}</p>
                        </div>
                        <div>
                            <span class="text-gray-400">Transactions:</span>
                            <p class="text-blue-400">${block.transactions.length}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function fetchMempool() {
            try {
                const response = await axios.get(`${API_BASE}/mempool`);
                const mempool = response.data;
                displayMempool(mempool);
            } catch (error) {
                console.error('Failed to fetch mempool:', error);
                document.getElementById('mempool-container').innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <p>Failed to load mempool: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayMempool(mempool) {
            const container = document.getElementById('mempool-container');
            
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 mb-4">
                    <h3 class="text-lg font-semibold mb-2">Mempool Size</h3>
                    <p class="text-2xl font-bold text-green-400">${mempool.size} transactions</p>
                </div>
            `;

            if (mempool.transactions.length === 0) {
                container.innerHTML += '<div class="text-center py-8 text-gray-400">No transactions in mempool</div>';
                return;
            }

            container.innerHTML += mempool.transactions.map(tx => `
                <div class="bg-gray-800 rounded-lg p-4 hover:bg-gray-750 transition-colors">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-mono text-sm text-blue-400">${tx.id}</h4>
                        <p class="text-sm text-green-400">${(tx.amount / 100000000).toFixed(8)} KAS</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                        <div>
                            <span class="text-gray-400">Inputs:</span>
                            <p class="font-mono break-all">${tx.inputs.length}</p>
                        </div>
                        <div>
                            <span class="text-gray-400">Outputs:</span>
                            <p class="font-mono break-all">${tx.outputs.length}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-blue-400', 'border-b-2', 'border-blue-400');
                button.classList.add('text-gray-400', 'hover:text-gray-200');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Set active button
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            activeButton.classList.remove('text-gray-400', 'hover:text-gray-200');
            activeButton.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
            
            currentTab = tabName;
            
            // Load data for the tab
            if (tabName === 'blocks') {
                refreshBlocks();
            } else if (tabName === 'mempool') {
                refreshMempool();
            }
        }

        function refreshBlocks() {
            document.getElementById('blocks-container').innerHTML = `
                <div class="text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p>Loading blocks...</p>
                </div>
            `;
            fetchBlocks();
        }

        function refreshMempool() {
            document.getElementById('mempool-container').innerHTML = `
                <div class="text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p>Loading mempool...</p>
                </div>
            `;
            fetchMempool();
        }

        async function searchAddress() {
            const addressInput = document.getElementById('address-input');
            const addressResult = document.getElementById('address-result');
            const address = addressInput.value.trim();
            
            if (!address) {
                alert('Please enter a Kaspa address');
                return;
            }
            
            // Show loading
            addressResult.innerHTML = `
                <div class="text-center py-4">
                    <div class="loader mx-auto mb-2"></div>
                    <p>Searching address...</p>
                </div>
            `;
            addressResult.classList.remove('hidden');
            
            try {
                const response = await axios.get(`${API_BASE}/address/${encodeURIComponent(address)}`);
                const balanceData = response.data;
                
                addressResult.innerHTML = `
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <span class="text-gray-400 text-sm">Address:</span>
                                <p class="font-mono text-xs break-all">${balanceData.address}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-gray-400 text-sm">Balance:</span>
                                <p class="text-2xl font-bold text-green-400">${(balanceData.balance / 100000000).toFixed(8)} KAS</p>
                            </div>
                        </div>
                        <div>
                            <span class="text-gray-400 text-sm">UTXOs (${balanceData.utxos.length}):</span>
                            <div class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                                ${balanceData.utxos.map(utxo => `
                                    <div class="bg-gray-600 rounded p-2 text-xs">
                                        <div class="flex justify-between">
                                            <span class="font-mono">${utxo.outpoint}</span>
                                            <span class="text-green-400">${(utxo.amount / 100000000).toFixed(8)} KAS</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to fetch address balance:', error);
                addressResult.innerHTML = `
                    <div class="bg-red-900 bg-opacity-50 rounded-lg p-4">
                        <p class="text-red-400">Failed to fetch address balance: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Initialize
        async function init() {
            await fetchNetworkInfo();
            fetchBlocks();
            
            // Auto-refresh every 30 seconds
            setInterval(async () => {
                const isConnected = await fetchNetworkInfo();
                if (isConnected) {
                    if (currentTab === 'blocks') {
                        fetchBlocks();
                    } else if (currentTab === 'mempool') {
                        fetchMempool();
                    }
                }
            }, 30000);
        }

        // Start the app
        init();
    </script>
</body>
</html>
