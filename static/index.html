<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa Testnet 12 Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--kaspa-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Kaspa Brand Colors */
        :root {
            --kaspa-primary: #70c7ba;
            --kaspa-accent: #49eacb;
            --surface-dark: rgba(18, 20, 24, 0.78);
            --surface-light: rgba(255, 255, 255, 0.92);
            --bg-gradient-start: #0c0d10;
            --bg-gradient-mid: #121418;
            --text-primary: rgba(255, 255, 255, 0.92);
            --text-secondary: rgba(255, 255, 255, 0.55);
            --card-border: rgba(255, 255, 255, 0.10);
            --shadow: 0 30px 80px rgba(0, 0, 0, 0.55);
            --font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --kaspa-glow: rgba(73, 234, 203, 0.18);
            --bg-0: var(--bg-gradient-start);
            --bg-1: var(--bg-gradient-mid);
            --bg-2: #0b0c0f;
            --surface-0: rgba(14, 16, 18, 0.58);
            --surface-1: rgba(14, 16, 18, 0.72);
            --surface-2: rgba(14, 16, 18, 0.86);
            --border: var(--card-border);
            --border-strong: rgba(255, 255, 255, 0.14);
            --text: var(--text-primary);
            --text-muted: var(--text-secondary);
            --shadow-soft: 0 22px 60px rgba(0, 0, 0, 0.42);
            --radius-xl: 22px;
            --radius-lg: 18px;
            --radius-md: 14px;
        }
        
        .kaspa-primary { color: var(--kaspa-primary); }
        .kaspa-accent { color: var(--kaspa-accent); }
        .kaspa-glow { color: var(--kaspa-glow); }
        
        .bg-kaspa-primary { background-color: var(--kaspa-primary); }
        .bg-kaspa-accent { background-color: var(--kaspa-accent); }
        .bg-surface-dark { background-color: var(--surface-dark); }
        .bg-surface-1 { background-color: var(--surface-1); }
        .bg-surface-2 { background-color: var(--surface-2); }
        
        .border-kaspa-primary { border-color: var(--kaspa-primary); }
        .border-card { border-color: var(--card-border); }
        
        .hover-bg-kaspa-primary:hover { background-color: var(--kaspa-accent); }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-1);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--kaspa-primary);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--kaspa-accent);
        }
        
        body {
            font-family: var(--font-family);
            background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 62%, var(--bg-gradient-start) 100%);
            color: var(--text);
            min-height: 100vh;
            letter-spacing: 0.01em;
        }
        
        body::before {
            content: "";
            position: fixed;
            inset: -2px;
            pointer-events: none;
            background:
                radial-gradient(1200px 720px at 50% 40%, rgba(0, 0, 0, 0.00) 0%, rgba(0, 0, 0, 0.52) 72%, rgba(0, 0, 0, 0.78) 100%),
                radial-gradient(700px 420px at 50% 35%, rgba(73, 234, 203, 0.04) 0%, rgba(73, 234, 203, 0) 60%);
            filter: blur(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <nav class="bg-surface-1 border-b border-card">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold kaspa-primary">Kaspa Testnet 12 Explorer</h1>
                <div id="network-status" class="flex items-center space-x-2">
                    <div class="loader" id="status-loader"></div>
                    <span id="status-text">Connecting...</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Network Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-surface-1 rounded-lg p-6 border border-card">
                <h3 class="text-lg font-semibold mb-2 kaspa-primary">Network</h3>
                <p class="text-2xl font-bold" id="network-name">-</p>
            </div>
            <div class="bg-surface-1 rounded-lg p-6 border border-card">
                <h3 class="text-lg font-semibold mb-2 text-green-400">Server</h3>
                <p class="text-sm font-mono" id="server-url">-</p>
            </div>
            <div class="bg-surface-1 rounded-lg p-6 border border-card">
                <h3 class="text-lg font-semibold mb-2 kaspa-primary">Status</h3>
                <p class="text-2xl font-bold" id="connection-status">-</p>
            </div>
        </div>

        <!-- Address Search -->
        <div class="bg-surface-1 rounded-lg p-6 mb-8 border border-card">
            <h3 class="text-lg font-semibold mb-4 kaspa-primary">Address Balance Lookup</h3>
            <div class="flex space-x-4">
                <input 
                    type="text" 
                    id="address-input" 
                    placeholder="Enter Kaspa address (e.g., kaspatest:qpeyn23ju80dkgx3puldxuhmesey208lzh36kej8efk7lla6gufeqe8gt9vhg)"
                    class="flex-1 px-4 py-2 bg-surface-2 border border-card rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-kaspa-primary"
                />
                <button 
                    onclick="searchAddress()" 
                    class="bg-kaspa-primary hover-bg-kaspa-primary px-6 py-2 rounded-lg text-sm font-medium text-white"
                >
                    Search Address
                </button>
            </div>
            <div id="address-result" class="mt-4 hidden">
                <!-- Address balance results will be displayed here -->
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-card mb-6">
            <nav class="-mb-px flex space-x-8">
                <button onclick="showTab('blocks')" class="tab-button kaspa-primary border-b-2 border-kaspa-primary py-2 px-1 text-sm font-medium" data-tab="blocks">
                    Latest Blocks
                </button>
                <button onclick="showTab('mempool')" class="tab-button text-gray-400 hover:text-gray-200 py-2 px-1 text-sm font-medium" data-tab="mempool">
                    Mempool
                </button>
            </nav>
        </div>

        <!-- Blocks Tab -->
        <div id="blocks-tab" class="tab-content">
            <div class="mb-4">
                <button onclick="refreshBlocks()" class="bg-kaspa-primary hover-bg-kaspa-primary px-4 py-2 rounded-lg text-sm font-medium text-white">
                    Refresh Blocks
                </button>
            </div>
            <div id="blocks-container" class="space-y-4">
                <div class="text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p>Loading blocks...</p>
                </div>
            </div>
        </div>

        <!-- Mempool Tab -->
        <div id="mempool-tab" class="tab-content hidden">
            <div class="mb-4">
                <button onclick="refreshMempool()" class="bg-kaspa-primary hover-bg-kaspa-primary px-4 py-2 rounded-lg text-sm font-medium text-white">
                    Refresh Mempool
                </button>
            </div>
            <div id="mempool-container" class="space-y-4">
                <div class="text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p>Loading mempool...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let isLoading = {
            blocks: false,
            mempool: false,
            address: false
        };

        // Debounce function to prevent excessive API calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle function for auto-refresh
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        // Initialize
        let currentTab = 'blocks';
        let refreshInterval;
        
        // Debounced address search to prevent excessive API calls
        const debouncedSearchAddress = debounce(async function() {
            await performAddressSearch();
        }, 500);
        
        // Throttled auto-refresh to reduce server load
        const throttledRefresh = throttle(async function() {
            const isConnected = await fetchNetworkInfo();
            if (isConnected) {
                if (currentTab === 'blocks') {
                    fetchBlocks();
                } else if (currentTab === 'mempool') {
                    fetchMempool();
                }
            }
        }, 5000); // Throttle to every 5 seconds max

        async function fetchNetworkInfo() {
            try {
                const response = await axios.get(`${API_BASE}/info`);
                const info = response.data;
                
                document.getElementById('network-name').textContent = info.network;
                document.getElementById('server-url').textContent = info.server_url;
                document.getElementById('connection-status').textContent = info.is_connected ? 'Connected' : 'Disconnected';
                
                const statusLoader = document.getElementById('status-loader');
                const statusText = document.getElementById('status-text');
                
                if (info.is_connected) {
                    statusLoader.style.display = 'none';
                    statusText.textContent = 'Connected';
                    statusText.className = 'text-green-400';
                } else {
                    statusLoader.style.display = 'block';
                    statusText.textContent = 'Disconnected';
                    statusText.className = 'text-red-400';
                }
                
                return info.is_connected;
            } catch (error) {
                console.error('Failed to fetch network info:', error);
                document.getElementById('status-loader').style.display = 'none';
                document.getElementById('status-text').textContent = 'Error';
                document.getElementById('status-text').className = 'text-red-400';
                return false;
            }
        }

        async function fetchBlocks() {
            try {
                const response = await axios.get(`${API_BASE}/blocks`);
                const blocks = response.data;
                displayBlocks(blocks);
            } catch (error) {
                console.error('Failed to fetch blocks:', error);
                document.getElementById('blocks-container').innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <p>Failed to load blocks: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayBlocks(blocks) {
            const container = document.getElementById('blocks-container');
            
            if (blocks.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No blocks found</div>';
                return;
            }

            container.innerHTML = blocks.map(block => `
                <div class="bg-surface-1 rounded-lg p-6 border border-card hover:bg-surface-2 transition-colors">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <span class="kaspa-primary font-mono text-sm">#${block.level}</span>
                            <h3 class="font-mono text-sm break-all">${block.hash}</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-400">${new Date(block.timestamp * 1000).toLocaleString()}</p>
                            <p class="text-xs text-gray-500">Difficulty: ${block.difficulty.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-400">Parents:</span>
                            <p class="font-mono text-xs break-all">${block.parents || 'None'}</p>
                        </div>
                        <div>
                            <span class="text-gray-400">Transactions:</span>
                            <p class="kaspa-primary">${block.transactions.length}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function fetchMempool() {
            try {
                const response = await axios.get(`${API_BASE}/mempool`);
                const mempool = response.data;
                displayMempool(mempool);
            } catch (error) {
                console.error('Failed to fetch mempool:', error);
                document.getElementById('mempool-container').innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <p>Failed to load mempool: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayMempool(mempool) {
            const container = document.getElementById('mempool-container');
            
            container.innerHTML = `
                <div class="bg-surface-1 rounded-lg p-6 mb-4 border border-card">
                    <h3 class="text-lg font-semibold mb-2">Mempool Size</h3>
                    <p class="text-2xl font-bold kaspa-primary">${mempool.size} transactions</p>
                </div>
            `;

            if (mempool.transactions.length === 0) {
                container.innerHTML += '<div class="text-center py-8 text-gray-400">No transactions in mempool</div>';
                return;
            }

            container.innerHTML += mempool.transactions.map(tx => `
                <div class="bg-surface-1 rounded-lg p-4 border border-card hover:bg-surface-2 transition-colors">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-mono text-sm kaspa-primary">${tx.id}</h4>
                        <p class="text-sm text-green-400">${(tx.amount / 100000000).toFixed(8)} KAS</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                        <div>
                            <span class="text-gray-400">Inputs:</span>
                            <p class="font-mono break-all">${tx.inputs.length}</p>
                        </div>
                        <div>
                            <span class="text-gray-400">Outputs:</span>
                            <p class="font-mono break-all">${tx.outputs.length}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('kaspa-primary', 'border-b-2', 'border-kaspa-primary');
                button.classList.add('text-gray-400', 'hover:text-gray-200');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Set active button
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            activeButton.classList.remove('text-gray-400', 'hover:text-gray-200');
            activeButton.classList.add('kaspa-primary', 'border-b-2', 'border-kaspa-primary');
            
            currentTab = tabName;
            
            // Load data for the tab
            if (tabName === 'blocks') {
                refreshBlocks();
            } else if (tabName === 'mempool') {
                refreshMempool();
            }
        }

        function refreshBlocks() {
            if (isLoading.blocks) return; // Prevent multiple simultaneous requests
            isLoading.blocks = true;
            
            document.getElementById('blocks-container').innerHTML = `
                <div class="text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p>Loading blocks...</p>
                </div>
            `;
            fetchBlocks().finally(() => {
                isLoading.blocks = false;
            });
        }

        function refreshMempool() {
            if (isLoading.mempool) return; // Prevent multiple simultaneous requests
            isLoading.mempool = true;
            
            document.getElementById('mempool-container').innerHTML = `
                <div class="text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p>Loading mempool...</p>
                </div>
            `;
            fetchMempool().finally(() => {
                isLoading.mempool = false;
            });
        }

        async function searchAddress() {
            debouncedSearchAddress();
        }
        
        async function performAddressSearch() {
            const addressInput = document.getElementById('address-input');
            const addressResult = document.getElementById('address-result');
            const address = addressInput.value.trim();
            
            if (!address) {
                alert('Please enter a Kaspa address');
                return;
            }
            
            if (isLoading.address) return; // Prevent multiple simultaneous requests
            isLoading.address = true;
            
            // Show loading
            addressResult.innerHTML = `
                <div class="text-center py-4">
                    <div class="loader mx-auto mb-2"></div>
                    <p>Searching address...</p>
                </div>
            `;
            addressResult.classList.remove('hidden');
            
            try {
                const response = await axios.get(`${API_BASE}/address/${encodeURIComponent(address)}`);
                const balanceData = response.data;
                
                addressResult.innerHTML = `
                    <div class="bg-surface-2 rounded-lg p-4 border border-card">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <span class="text-gray-400 text-sm">Address:</span>
                                <p class="font-mono text-xs break-all">${balanceData.address}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-gray-400 text-sm">Balance:</span>
                                <p class="text-2xl font-bold text-green-400">${(balanceData.balance / 100000000).toFixed(8)} KAS</p>
                            </div>
                        </div>
                        <div>
                            <span class="text-gray-400 text-sm">UTXOs (${balanceData.utxos.length}):</span>
                            <div class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                                ${balanceData.utxos.slice(0, 20).map(utxo => `
                                    <div class="bg-surface-1 rounded p-2 text-xs border border-card">
                                        <div class="flex justify-between">
                                            <span class="font-mono">${utxo.outpoint}</span>
                                            <span class="text-green-400">${(utxo.amount / 100000000).toFixed(8)} KAS</span>
                                        </div>
                                    </div>
                                `).join('')}
                                ${balanceData.utxos.length > 20 ? `
                                    <div class="text-center text-gray-400 text-xs">
                                        ... and ${balanceData.utxos.length - 20} more UTXOs
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to fetch address balance:', error);
                addressResult.innerHTML = `
                    <div class="bg-red-900 bg-opacity-50 rounded-lg p-4">
                        <p class="text-red-400">Failed to fetch address balance: ${error.message}</p>
                    </div>
                `;
            } finally {
                isLoading.address = false;
            }
        }

        // Initialize
        async function init() {
            await fetchNetworkInfo();
            fetchBlocks();
            
            // Use throttled auto-refresh instead of setInterval to reduce load
            setInterval(() => {
                throttledRefresh();
            }, 30000); // Check every 30 seconds, but actual refresh is throttled
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
